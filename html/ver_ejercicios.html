<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BASE DE DATOS DE EJERCICIOS</title>
    <link rel="stylesheet" href="../css/style.css"> <!-- Enlace a la hoja de estilos -->
</head>
<body>
    <!-- Título principal de la página -->
    <h1>BASE DE DATOS DE EJERCICIOS</h1>

    <!-- Contenedor principal para distribuir la página en filtros a la izquierda y resultados al centro -->
    <div class="main-container">

        <!-- Contenedor para los filtros (alineado a la izquierda) -->
        <div class="filters-container">
            <!-- Estructura de la tabla de filtros -->
            <table id="filtersTable" class="filters-vertical">
                <tbody id="filters">
                    <!-- Aquí se generarán los filtros dinámicamente con JavaScript -->
                </tbody>
            </table>
            <!-- Botón para aplicar filtros -->
            <button id="applyFilters" class="button">Aplicar Filtros</button>
            <!-- Botón para añadir ejercicio -->
            <button id="addExerciseButton" class="button-secondary">Añadir Ejercicio</button>
            <!-- Botón para volver a la página principal -->
            <button id="backButton" class="button back-button">Volver</button>
        </div>

        <!-- Contenedor para la tabla de resultados (centrado) -->
        <div class="results-container">
            <!-- Contador de resultados encontrados -->
            <div id="resultsCount" class="results-count">
                Resultados encontrados: 0
            </div>

            <!-- Tabla para mostrar los resultados de los ejercicios -->
            <table id="resultsTable" class="table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre Ejercicio</th>
                        <th>Clasificación</th>
                        <th>Grupo Muscular</th>
                        <th>Agonista</th>
                        <th>Nivel de Dificultad</th>
                        <th>Equipamiento</th>
                        <th>Video</th> <!-- Solo dejamos las columnas que queremos mostrar -->
                        <th>Acciones</th> <!-- Columna nueva para botones de acciones -->
                    </tr>
                </thead>
                <tbody>
                    <!-- Aquí se insertarán los resultados filtrados dinámicamente -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Script para gestionar los filtros y la carga dinámica de la tabla -->
    <script>
        // Variables para almacenar el estado de los filtros aplicados
        let appliedFilters = {};

        document.addEventListener('DOMContentLoaded', function () {
            // Cargar los datos de los ejercicios y los filtros dinámicamente
            loadExercisesAndFilters();

            // Asignar evento al botón "Aplicar Filtros"
            document.getElementById('applyFilters').addEventListener('click', function () {
                applyFilters();
            });

            // Asignar evento al botón "Añadir Ejercicio"
            document.getElementById('addExerciseButton').addEventListener('click', function () {
                window.location.href = 'add_exercise.html';
            });

            // Asignar evento al botón "Volver"
            document.getElementById('backButton').addEventListener('click', function () {
                window.location.href = 'menuroot.html';
            });

            // Si volvemos a esta página desde modificar o añadir, restaurar los filtros anteriores
            if (sessionStorage.getItem('appliedFilters')) {
                restoreFilters();
            }
        });

        // Función para cargar los datos de los ejercicios y generar los filtros
        function loadExercisesAndFilters() {
            fetch('../php/listar_ejercicios.php')
                .then(response => response.json())
                .then(data => {
                    // Generar los menús desplegables para los filtros
                    createFilters(data);
                    // Mostrar todos los ejercicios en la tabla inicialmente
                    displayResults(data);

                    // Aplicar los filtros previamente guardados después de que los filtros estén creados
                    if (sessionStorage.getItem('appliedFilters')) {
                        restoreFilters();
                    }
                })
                .catch(error => console.error('Error al cargar los ejercicios:', error));
        }

        // Función para generar los menús desplegables de los filtros
        function createFilters(data) {
            const uniqueValues = {};

            // Definir las columnas que se utilizarán para los filtros
            const filterColumns = [
                'clasificacion',
                'grupo_muscular',
                'agonista',
                'nivel_dificultad',
                'equipamiento',
                'patron_movimientos',
                'plano_ejecucion',
                'lateralidad'
            ];

            // Recopilar valores únicos de cada columna para los filtros
            filterColumns.forEach(column => {
                uniqueValues[column] = [...new Set(data.map(item => item[column]).filter(Boolean))];
            });

            // Crear los selectores para cada filtro en la tabla
            filterColumns.forEach(column => {
                console.log(`Creando filtro para la columna: ${column}`); // Log para verificar la creación

                const tr = document.createElement('tr'); // Fila para cada filtro
                const tdLabel = document.createElement('td');
                tdLabel.colSpan = 2;
                const label = document.createElement('label');
                label.textContent = column.charAt(0).toUpperCase() + column.slice(1).replace('_', ' ');
                label.htmlFor = `filter-${column}`;
                tdLabel.appendChild(label);
                const trLabel = document.createElement('tr');
                trLabel.appendChild(tdLabel);
                document.getElementById('filters').appendChild(trLabel);

                const trSelect = document.createElement('tr');
                const tdSelect = document.createElement('td');
                tdSelect.colSpan = 2;
                const select = document.createElement('select');
                select.id = `filter-${column}`;
                select.innerHTML = '<option value="">Todos</option>';

                uniqueValues[column].forEach(value => {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = value;
                    select.appendChild(option);
                });

                tdSelect.appendChild(select);
                trSelect.appendChild(tdSelect);
                document.getElementById('filters').appendChild(trSelect);

                console.log(`Filtro ${column} creado correctamente con id "filter-${column}"`); // Log de éxito
            });
        }

        // Función para mostrar los ejercicios en la tabla de resultados
        function displayResults(data) {
            const tableBody = document.querySelector('#resultsTable tbody');
            tableBody.innerHTML = ''; // Limpiar la tabla antes de agregar nuevos resultados

            // Recorrer cada fila de datos y agregarla a la tabla
            data.forEach(row => {
                const tr = document.createElement('tr');

                // Crear celdas para cada columna que queremos mostrar
                ['id', 'nombre_ejercicio', 'clasificacion', 'grupo_muscular', 'agonista', 'nivel_dificultad', 'equipamiento', 'video'].forEach(key => {
                    const td = document.createElement('td');

                    if (key === 'video') {
                        const link = document.createElement('a');
                        link.href = row[key];
                        link.textContent = 'Ver Video';
                        link.target = '_blank';
                        td.appendChild(link);
                    } else {
                        td.textContent = row[key] || '';
                    }

                    tr.appendChild(td);
                });

                // Añadir la columna de acciones (Modificar/Eliminar)
                const actionTd = document.createElement('td');
                actionTd.classList.add('action-buttons-container');

                // Botón de Modificar
                const modifyButton = document.createElement('button');
                modifyButton.classList.add('action-button', 'modify-button');
                modifyButton.textContent = 'M'; // Etiqueta del botón de modificar
                modifyButton.onclick = () => modifyExercise(row.id);

                // Botón de Eliminar
                const deleteButton = document.createElement('button');
                deleteButton.classList.add('action-button', 'delete-button');
                deleteButton.textContent = 'X'; // Etiqueta del botón de eliminar
                deleteButton.onclick = () => deleteExercise(row.id);

                // Añadir botones a la celda de acciones
                actionTd.appendChild(modifyButton);
                actionTd.appendChild(deleteButton);

                // Añadir la celda de acciones a la fila
                tr.appendChild(actionTd);

                tableBody.appendChild(tr); // Agregar la fila a la tabla
            });

            // Actualizar el contador de resultados
            document.getElementById('resultsCount').textContent = `Resultados encontrados: ${data.length}`;
        }

        // Función para aplicar los filtros seleccionados por el usuario
        function applyFilters() {
            fetch('../php/listar_ejercicios.php')
                .then(response => response.json())
                .then(data => {
                    // Leer los valores seleccionados en los filtros
                    const filters = {};
                    const filterColumns = [
                        'clasificacion',
                        'grupo_muscular',
                        'agonista',
                        'nivel_dificultad',
                        'equipamiento',
                        'patron_movimientos',
                        'plano_ejecucion',
                        'lateralidad'
                    ];

                    filterColumns.forEach(column => {
                        const selectedValue = document.getElementById(`filter-${column}`).value;
                        if (selectedValue) {
                            filters[column] = selectedValue;
                        }
                    });

                    // Filtrar los datos según los valores seleccionados en los filtros
                    const filteredData = data.filter(row => {
                        return Object.keys(filters).every(column => row[column] === filters[column]);
                    });

                    // Mostrar los resultados filtrados en la tabla
                    displayResults(filteredData);

                    // Guardar los filtros aplicados en sessionStorage
                    sessionStorage.setItem('appliedFilters', JSON.stringify(filters));
                })
                .catch(error => console.error('Error al aplicar los filtros:', error));
        }

        // Función para restaurar los filtros aplicados desde sessionStorage
        function restoreFilters() {
            const filters = JSON.parse(sessionStorage.getItem('appliedFilters'));
            const filterColumns = [
                'clasificacion',
                'grupo_muscular',
                'agonista',
                'nivel_dificultad',
                'equipamiento',
                'patron_movimientos',
                'plano_ejecucion',
                'lateralidad'
            ];

            filterColumns.forEach(column => {
                const selectElement = document.getElementById(`filter-${column}`);
                if (selectElement) {
                    selectElement.value = filters[column] || ''; // Restaurar el valor del filtro
                } else {
                    console.warn(`El filtro para la columna ${column} no se encontró en el DOM.`);
                }
            });

            // Aplicar los filtros restaurados
            applyFilters();
        }

        // Función para redirigir a la página de modificación de un ejercicio
        function modifyExercise(id) {
            window.location.href = `modificar_ejercicio.html?id=${id}`;
        }

        // Función para eliminar un ejercicio
        function deleteExercise(id) {
            // Confirmar eliminación antes de proceder
            if (confirm('¿Estás seguro de que deseas eliminar este ejercicio?')) {
                fetch(`../php/eliminar_ejercicio.php?id=${id}`, { method: 'DELETE' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Ejercicio eliminado correctamente.');
                            // Recargar los datos y refrescar la tabla
                            loadExercisesAndFilters();
                        } else {
                            alert('Error al eliminar el ejercicio: ' + data.message);
                        }
                    })
                    .catch(error => console.error('Error al eliminar el ejercicio:', error));
            }
        }
    </script>
</body>
</html>
